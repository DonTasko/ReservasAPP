<script>
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbwb1vrj2-nN-qVyXvOEc7kqw1Cg13f9nufwR9ixZ6bBmihuRL7aYfhQ8AjZ-d53AU8/exec";
    const PASS_CORRETA = "Tasko123";
    let LOTACAO_MAX = 30;
    let ultimaContagem = 0;
    
    // Áudio de Alerta (Som de notificação curto)
    const somDing = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

    function verificarPass() {
        if (document.getElementById('passInput').value === PASS_CORRETA) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            document.getElementById('dataManual').value = new Date().toISOString().split('T')[0];
            carregarDados();
            setInterval(carregarDados, 60000); // Atualiza a cada 1 min para o som ser eficaz
        } else {
            document.getElementById('erro').style.display = 'block';
        }
    }

    async function carregarDados() {
        const dot = document.getElementById('statusDot');
        const statusTxt = document.getElementById('statusText');
        
        try {
            const [confRes, dashRes] = await Promise.all([
                fetch(URL_SCRIPT, { method: 'POST', body: JSON.stringify({action: 'getConfigs'}) }).then(r => r.json()),
                fetch(URL_SCRIPT, { method: 'POST', body: JSON.stringify({action: 'getDashboard'}) }).then(r => r.json())
            ]);

            LOTACAO_MAX = parseInt(confRes.LOTACAO_MAXIMA) || 30;
            
            // LÓGICA DO SOM: Toca se o número de reservas na lista geral aumentou
            if (ultimaContagem > 0 && dashRes.listaGeral.length > ultimaContagem) {
                somDing.play().catch(e => console.log("Som bloqueado pelo browser"));
            }
            ultimaContagem = dashRes.listaGeral.length;

            renderizarOcupacao(dashRes.resumoCompleto);
            renderizarProximasReservas(dashRes.listaGeral);
            verificarAlertas(dashRes.listaGeral);
            
            statusTxt.innerText = "Sincronizado: " + new Date().toLocaleTimeString('pt-PT');
        } catch (error) {
            statusTxt.innerText = "Erro na ligação";
        }
    }

    function renderizarOcupacao(resumo) {
        const div = document.getElementById('resumo15');
        div.innerHTML = '';
        Object.keys(resumo).sort().forEach(dataStr => {
            const p = resumo[dataStr];
            div.innerHTML += `
                <div class="dia-card">
                    <span class="dia-titulo">${formatarData(dataStr)}</span>
                    ${barra(p.almoco || 0, 'Almoço')}
                    ${barra(p.jantar || 0, 'Jantar')}
                </div>`;
        });
    }

    function barra(pax, label) {
        const perc = Math.min((pax/LOTACAO_MAX)*100, 100);
        let cor = (perc >= 100) ? 'color-full' : (perc >= 80) ? 'color-high' : (perc >= 50) ? 'color-mid' : 'color-low';
        return `<div class="periodo-row"><span>${label}</span>
                <div class="barra-progresso"><div class="barra-fill ${cor}" style="width:${perc}%"></div></div>
                <span><strong>${pax}</strong>/${LOTACAO_MAX}</span></div>`;
    }

    function renderizarProximasReservas(lista) {
        const tbody = document.querySelector('#tabelaProximas tbody');
        // Filtra para remover qualquer entrada inválida do ano 1899
        const listaLimpa = lista.filter(r => !r.data.includes("1899"));
        
        if (listaLimpa.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Sem reservas.</td></tr>';
            return;
        }

        tbody.innerHTML = listaLimpa.map(r => `
            <tr>
                <td><span class="date-text">${formatarData(r.data)}</span><br><strong>${r.hora}</strong></td>
                <td><strong>${r.nome}</strong><br><small>${r.tel}</small></td>
                <td><span class="pax-badge">${r.pax} pax</span></td>
                <td style="font-size:12px; color:#666">${r.obs || ""}</td>
                <td><button class="btn-cancel" onclick="cancelarReserva('${r.nome}', '${r.hora}', '${r.data}')">Remover</button></td>
            </tr>
        `).join('');
    }

    function formatarData(dataStr) {
        if (!dataStr || dataStr.includes("1899")) return "---";
        const partes = dataStr.split('-'); 
        const dObj = new Date(partes[0], partes[1] - 1, partes[2]);
        const dias = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
        return `${dias[dObj.getDay()]}, ${partes[2]}/${partes[1]}`;
    }

    function verificarAlertas(lista) {
        const hoje = new Date().toISOString().split('T')[0];
        if (lista.some(r => r.data === hoje)) document.getElementById('statusDot').classList.add('pulse');
    }

    document.getElementById('formManual').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnManual');
        btn.disabled = true; btn.innerText = "A gravar...";
        const dados = Object.fromEntries(new FormData(this));
        dados.action = "reservaManual";
        
        try {
            await fetch(URL_SCRIPT, { method: 'POST', body: JSON.stringify(dados) });
            this.reset();
            document.getElementById('dataManual').value = new Date().toISOString().split('T')[0];
            await carregarDados();
        } catch(e) { alert("Erro ao gravar."); }
        
        btn.disabled = false; btn.innerText = "Confirmar Reserva";
    };

    async function cancelarReserva(n, h, d) {
        if (confirm(`Remover reserva de ${n}?`)) {
            await fetch(URL_SCRIPT, { method: 'POST', body: JSON.stringify({action: 'cancelarAdmin', nome: n, hora: h, data: d}) });
            carregarDados();
        }
    }
</script>
