<script>
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbwb1vrj2-nN-qVyXvOEc7kqw1Cg13f9nufwR9ixZ6bBmihuRL7aYfhQ8AjZ-d53AU8/exec";
    const PASS_CORRETA = "Tasko123";
    let LOTACAO_MAX = 30;

    // 1. GESTÃƒO DE ACESSO
    function verificarPass() {
        if (document.getElementById('passInput').value === PASS_CORRETA) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            
            // Define data de hoje no input sem desvio de fuso
            const hoje = new Date();
            const ano = hoje.getFullYear();
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const dia = String(hoje.getDate()).padStart(2, '0');
            document.getElementById('dataManual').value = `${ano}-${mes}-${dia}`;
            
            carregarDados();
        } else {
            document.getElementById('erro').style.display = 'block';
        }
    }

    // 2. CARREGAMENTO DE DADOS (API)
    async function carregarDados() {
        const btn = document.querySelector('.btn-refresh');
        btn.innerText = "ðŸ”„ A atualizar...";
        
        try {
            // Puxar ConfiguraÃ§Ãµes
            const configRes = await fetch(URL_SCRIPT, { method: 'POST', body: JSON.stringify({action: 'getConfigs'}) });
            const configs = await configRes.json();
            LOTACAO_MAX = parseInt(configs.LOTACAO_MAXIMA) || 30;

            // Puxar Dados do Dashboard
            const response = await fetch(URL_SCRIPT, { method: 'POST', body: JSON.stringify({action: 'getDashboard'}) });
            const data = await response.json();

            renderizarOcupacao(data.resumoCompleto);
            renderizarProximasReservas(data.listaGeral);

        } catch (error) {
            console.error("Erro ao carregar dados:", error);
            alert("Erro de ligaÃ§Ã£o ao servidor.");
        } finally {
            btn.innerText = "ðŸ”„ Atualizar Tudo";
        }
    }

    // 3. RENDERIZAÃ‡ÃƒO DA OCUPAÃ‡ÃƒO (15 DIAS)
    function renderizarOcupacao(resumo) {
        const resumoDiv = document.getElementById('resumo15');
        resumoDiv.innerHTML = '';
        
        // Ordenar datas cronologicamente
        const datas = Object.keys(resumo).sort();

        datas.forEach(dataStr => {
            const periodos = resumo[dataStr];
            const alm = periodos.almoco || 0;
            const jan = periodos.jantar || 0;

            resumoDiv.innerHTML += `
                <div class="dia-card">
                    <span class="dia-titulo">${formatarData(dataStr)}</span>
                    ${criarBarraPeriodo('AlmoÃ§o', alm)}
                    ${criarBarraPeriodo('Jantar', jan)}
                </div>
            `;
        });
    }

    function criarBarraPeriodo(label, pax) {
        const perc = Math.min((pax / LOTACAO_MAX) * 100, 100);
        let cor = 'color-low';
        if (perc >= 100) cor = 'color-full';
        else if (perc >= 80) cor = 'color-high';
        else if (perc >= 50) cor = 'color-mid';

        return `
            <div class="periodo-row">
                <span style="width:60px; font-weight:500;">${label}</span>
                <div class="barra-progresso">
                    <div class="barra-fill ${cor}" style="width: ${perc}%"></div>
                </div>
                <span style="width:50px; text-align:right"><strong>${pax}</strong>/${LOTACAO_MAX}</span>
            </div>
        `;
    }

    // 4. RENDERIZAÃ‡ÃƒO DA TABELA DE RESERVAS
    function renderizarProximasReservas(lista) {
        const tbody = document.querySelector('#tabelaProximas tbody');
        if (!lista || lista.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Sem reservas registadas.</td></tr>';
            return;
        }

        // Ordenar por Data e depois por Hora
        lista.sort((a, b) => (a.data + a.hora).localeCompare(b.data + b.hora));

        tbody.innerHTML = lista.map(r => `
            <tr>
                <td>
                    <span class="date-text">${formatarData(r.data)}</span>
                    <strong style="font-size:1.1em;">${r.hora}</strong>
                </td>
                <td>
                    <strong>${r.nome}</strong><br>
                    <small style="color:#666;">ðŸ“ž ${r.tel}</small>
                </td>
                <td><span class="pax-badge">${r.pax} pax</span></td>
                <td style="font-style:italic; color:#555; max-width:200px;">${r.obs || "---"}</td>
                <td>
                    <button class="btn-cancel" onclick="cancelarReserva('${r.nome}', '${r.hora}', '${r.data}')">
                        Cancelar
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // 5. FORMATADOR DE DATA (ANTI-FUSO HORÃRIO)
    function formatarData(dataStr) {
        if (!dataStr) return "---";
        // Remove qualquer parte de hora se existir (ex: 2026-01-30T23:00:00)
        const apenasData = dataStr.split('T')[0];
        const partes = apenasData.split('-'); 
        
        if (partes.length !== 3) return dataStr;

        const ano = partes[0];
        const mes = partes[1];
        const dia = partes[2];

        // Determinar dia da semana sem usar UTC (evita saltos de dia)
        const dataObj = new Date(ano, mes - 1, dia);
        const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b'];
        const semana = diasSemana[dataObj.getDay()];

        return `${semana}, ${dia}/${mes}`;
    }

    // 6. AÃ‡Ã•ES (CANCELAR E MANUAL)
    async function cancelarReserva(nome, hora, data) {
        if (confirm(`Deseja cancelar a reserva de ${nome} Ã s ${hora}?\nEsta aÃ§Ã£o nÃ£o pode ser desfeita.`)) {
            try {
                const res = await fetch(URL_SCRIPT, { 
                    method: 'POST', 
                    body: JSON.stringify({action: 'cancelarAdmin', nome, hora, data}) 
                });
                await carregarDados();
            } catch (e) { alert("Erro ao cancelar."); }
        }
    }

    // SubmissÃ£o de Reserva Manual
    document.getElementById('formManual').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnManual');
        const originalText = btn.innerText;
        
        btn.disabled = true;
        btn.innerText = "âŒ› A gravar...";
        
        const dados = Object.fromEntries(new FormData(this).entries());
        dados.action = "reservaManual";
        
        try {
            const response = await fetch(URL_SCRIPT, { method: 'POST', body: JSON.stringify(dados) });
            const res = await response.json();
            
            if(res.status === "success") {
                this.reset();
                // Repor data de hoje no input apÃ³s reset
                const hoje = new Date().toISOString().split('T')[0];
                document.getElementById('dataManual').value = hoje;
                await carregarDados();
            } else {
                alert("Erro: " + res.message);
            }
        } catch(e) { 
            alert("Erro de ligaÃ§Ã£o."); 
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    };

    // Atalho Enter para Login
    document.getElementById('passInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') verificarPass(); });
</script>
