<script>
    // CONFIG
    const CONFIG = {
        URL_SCRIPT: "https://script.google.com/macros/s/AKfycbziBFUSKq2M1W4fZI84TJYPJ8SPLpdHr5X6ZaA0jYiQZyjJSsNdbl1O5ZIbgxvDz1dF/exec",
        PASS_CORRETA: "Tasko123",
        LOTACAO_MAX: 30
    };

    let dataSelecionada = new Date().toISOString().split('T')[0];
    let todasReservas = {};
    let todasMesas = [];
    let resumoCompleto = { almoco: {}, jantar: {} };

    // ========== DEBUG CONSOLE ==========
    let debugMessages = [];
    function toggleDebug() {
        const console = document.getElementById('debug-console');
        console.classList.toggle('show');
    }
    
    function debugLog(message, data = null) {
        const timestamp = new Date().toLocaleTimeString('pt-PT');
        const logMessage = `[${timestamp}] ${message}`;
        console.log(logMessage, data || '');
        debugMessages.push(logMessage + (data ? '<br>‚ûú ' + JSON.stringify(data).substring(0, 150) : ''));
        if (debugMessages.length > 30) debugMessages.shift();
        const debugConsole = document.getElementById('debug-console');
        debugConsole.innerHTML = debugMessages.join('<br>');
        debugConsole.scrollTop = debugConsole.scrollHeight;
    }

    // LOGIN
    function verificarPass() {
        const senha = document.getElementById('passInput').value;
        if (senha === CONFIG.PASS_CORRETA) {
            debugLog('‚úì Login bem-sucedido');
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataManual').value = hoje;
            document.getElementById('dataManual').min = hoje;
            document.getElementById('dataSelecionada').value = hoje;
            inicializar();
        } else {
            debugLog('‚úó Login falhou');
            const erroEl = document.getElementById('erro');
            erroEl.style.display = 'block';
            setTimeout(() => erroEl.style.display = 'none', 3000);
        }
    }

    function logout() {
        if (confirm('Sair do painel?')) {
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('passInput').value = '';
        }
    }

    document.getElementById('passInput').addEventListener('keypress', (e) => { 
        if (e.key === 'Enter') verificarPass(); 
    });

    // INICIALIZAR
    async function inicializar() {
        debugLog('üöÄ Inicializando dashboard...');
        await carregarMesas();
        await carregarDados();
        renderizarSala();
    }

    // CARREGAR MESAS
    async function carregarMesas() {
        debugLog('üìç Carregando mesas...');
        try {
            const response = await fetch(CONFIG.URL_SCRIPT, {
                method: 'POST',
                body: JSON.stringify({ action: 'getMesas' })
            });
            const data = await response.json();
            if (data.mesas && data.mesas.length > 0) {
                todasMesas = data.mesas;
            } else {
                usarMesasPadrao();
            }
        } catch (error) {
            usarMesasPadrao();
        }
    }

    function usarMesasPadrao() {
        todasMesas = [
            { id: 1, nome: 'Mesa 1', lugares: 4, x: 50, y: 50 },
            { id: 2, nome: 'Mesa 2', lugares: 6, x: 200, y: 50 },
            { id: 4, nome: 'Mesa 4', lugares: 4, x: 350, y: 50 },
            { id: 5, nome: 'Mesa 5', lugares: 4, x: 50, y: 200 },
            { id: 6, nome: 'Mesa 6', lugares: 4, x: 200, y: 200 },
            { id: 7, nome: 'Mesa 7', lugares: 4, x: 350, y: 200 },
            { id: 8, nome: 'Mesa 8', lugares: 4, x: 50, y: 350 },
            { id: 9, nome: 'Mesa 9', lugares: 4, x: 200, y: 350 },
        ];
    }

    // --- FUN√á√ÉO CORRIGIDA ---
    async function carregarDados() {
        debugLog('üìä Carregando dados do dashboard...');
        try {
            const response = await fetch(CONFIG.URL_SCRIPT, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'getDashboard' })
            });
            
            const data = await response.json();
            
            // Garantir compatibilidade de formatos [cite: 74, 76]
            if (data.todasReservas) {
                todasReservas = data.todasReservas;
            } else if (data.listaHoje) {
                const hoje = new Date().toISOString().split('T')[0];
                todasReservas = { [hoje]: data.listaHoje };
            } else {
                todasReservas = {};
            }
            
            // Resumo por turnos [cite: 77]
            if (data.resumoAlmoco && data.resumoJantar) {
                resumoCompleto.almoco = data.resumoAlmoco;
                resumoCompleto.jantar = data.resumoJantar;
            }
            
            // For√ßar atualiza√ß√£o da UI ap√≥s carregar [cite: 79]
            atualizarStats();
            renderizarLista();
            atualizarOcupacaoMesas();
            debugLog('‚úì Dados e interface atualizados');
            
        } catch (error) {
            debugLog('‚úó ERRO:', error);
            alert('Erro ao carregar dados: ' + error.message);
        }
    }

    // ATUALIZAR STATS
    function atualizarStats() {
        const almoco = resumoCompleto.almoco[dataSelecionada] || 0;
        const jantar = resumoCompleto.jantar[dataSelecionada] || 0;
        document.getElementById('statAlmoco').textContent = almoco;
        document.getElementById('statJantar').textContent = jantar;
    }

    // MUDAR DATA [cite: 83]
    function mudarData() {
        dataSelecionada = document.getElementById('dataSelecionada').value;
        debugLog('üìÖ Data alterada para:', dataSelecionada);
        atualizarStats();
        renderizarLista();
        atualizarOcupacaoMesas();
    }

    // RENDERIZAR SALA
    function renderizarSala() {
        const container = document.getElementById('salaContainer');
        container.innerHTML = '';
        todasMesas.forEach(mesa => {
            const mesaEl = document.createElement('div');
            mesaEl.className = 'mesa livre';
            mesaEl.id = `mesa-${mesa.id}`;
            mesaEl.style.left = (mesa.x || 50) + 'px';
            mesaEl.style.top = (mesa.y || 50) + 'px';
            mesaEl.draggable = true;
            mesaEl.innerHTML = `<div class="mesa-cliente"></div><div class="mesa-numero">${mesa.nome}</div><div class="mesa-lugares">${mesa.lugares} lugares</div>`;
            mesaEl.addEventListener('dragstart', handleDragStart);
            mesaEl.addEventListener('dragend', handleDragEnd);
            container.appendChild(mesaEl);
        });
        container.addEventListener('dragover', handleDragOver);
        container.addEventListener('drop', handleDrop);
    }

    // ATUALIZAR OCUPA√á√ÉO [cite: 86, 88]
    function atualizarOcupacaoMesas() {
        const reservasDoDia = todasReservas[dataSelecionada] || [];
        document.querySelectorAll('.mesa').forEach(mesaEl => {
            mesaEl.className = 'mesa livre';
            mesaEl.querySelector('.mesa-cliente').textContent = '';
        });
        reservasDoDia.forEach(reserva => {
            if (reserva.mesa) {
                const mesaEl = document.getElementById(`mesa-${reserva.mesa}`);
                if (mesaEl) {
                    mesaEl.className = reserva.status === 'Chegou' ? 'mesa ocupada' : 'mesa reservada';
                    mesaEl.querySelector('.mesa-cliente').textContent = reserva.nome;
                }
            }
        });
    }

    // RENDERIZAR LISTA [cite: 89, 91]
    function renderizarLista() {
        const lista = document.getElementById('reservasList');
        const reservasDoDia = todasReservas[dataSelecionada] || [];
        if (reservasDoDia.length === 0) {
            lista.innerHTML = '<div class="empty-state">üì≠ Sem reservas para esta data</div>';
            return;
        }
        lista.innerHTML = reservasDoDia
            .sort((a, b) => (a.hora || '').localeCompare(b.hora || ''))
            .map(reserva => `
                <div class="reserva-item ${reserva.status === 'Chegou' ? 'chegou' : ''}">
                    <div class="hora">${reserva.hora || '--:--'}</div>
                    <div class="nome">${reserva.nome}</div>
                    <div class="detalhes">üë• ${reserva.pax} pessoas ${reserva.tel ? ' ‚Ä¢ üìû ' + reserva.tel : ''}</div>
                    <div class="acoes">
                        ${reserva.status === 'Confirmada' ? `<button class="btn-pequeno btn-chegou" onclick="marcarChegada('${reserva.id}')">‚úÖ Chegou</button>` : ''}
                        <button class="btn-pequeno btn-cancelar" onclick="cancelarReserva('${reserva.id}', '${reserva.nome}')">üóëÔ∏è Cancelar</button>
                    </div>
                </div>`).join('');
    }

    // DRAG & DROP
    let draggedElement = null;
    let offsetX, offsetY;
    function handleDragStart(e) {
        draggedElement = e.target;
        const rect = draggedElement.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        draggedElement.style.opacity = '0.5';
    }
    function handleDragEnd(e) {
        draggedElement.style.opacity = '1';
        draggedElement = null;
    }
    function handleDragOver(e) { e.preventDefault(); }
    function handleDrop(e) {
        e.preventDefault();
        if (draggedElement) {
            const container = document.getElementById('salaContainer');
            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left - offsetX;
            const y = e.clientY - rect.top - offsetY;
            draggedElement.style.left = Math.max(0, x) + 'px';
            draggedElement.style.top = Math.max(0, y) + 'px';
        }
    }

    // A√á√ïES (MARCAR CHEGADA / CANCELAR) [cite: 101, 105]
    async function marcarChegada(id) {
        if (!confirm('Confirma chegada?')) return;
        const resp = await fetch(CONFIG.URL_SCRIPT, { method: 'POST', body: JSON.stringify({ action: 'marcarChegada', id: id }) });
        const res = await resp.json();
        if (res.status === 'success') carregarDados();
    }

    async function cancelarReserva(id, nome) {
        if (!confirm(`Cancelar reserva de ${nome}?`)) return;
        const resp = await fetch(CONFIG.URL_SCRIPT, { method: 'POST', body: JSON.stringify({ action: 'cancelarReserva', id: id }) });
        const res = await resp.json();
        if (res.status === 'success') carregarDados();
    }

    // FORMUL√ÅRIO MANUAL [cite: 110, 111]
    document.getElementById('formManual').onsubmit = async function(e) {
        e.preventDefault();
        const btn = this.querySelector('.btn-add');
        btn.disabled = true;
        try {
            const formData = new FormData(this);
            const dados = Object.fromEntries(formData.entries());
            dados.action = "reservaManual";
            const response = await fetch(CONFIG.URL_SCRIPT, { method: 'POST', body: JSON.stringify(dados) });
            const resultado = await response.json();
            if (resultado.status === 'success') {
                alert('‚úÖ Reserva criada!');
                this.reset();
                carregarDados();
            }
        } finally { btn.disabled = false; }
    };
</script>
