<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Privada | Don Tasko</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #e74c3c; --warning: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; color: #1c1e21; margin: 0; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.3); }
        .login-box input { padding: 12px; width: 250px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; display: block; font-size: 16px; }
        .login-box button { background: var(--accent); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }
        #dashboard-content { display: none; max-width: 1400px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        .live-status { display: flex; align-items: center; gap: 10px; background: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .dot { height: 12px; width: 12px; background-color: #bbb; border-radius: 50%; display: inline-block; }
        .pulse { background-color: var(--danger); animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        .container { display: grid; grid-template-columns: 380px 1fr; gap: 25px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        h2 { margin-top: 0; font-size: 18px; color: var(--primary); border-bottom: 2px solid #f0f2f5; padding-bottom: 15px; }
        .scroll-resumo { max-height: 550px; overflow-y: auto; }
        .dia-card { border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 12px; }
        .barra-progresso { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin: 5px 0; }
        .barra-fill { height: 100%; transition: width 0.5s; }
        .color-low { background: #2ecc71; } .color-mid { background: #f1c40f; } .color-high { background: #e67e22; } .color-full { background: var(--danger); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; background: #f8f9fa; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .btn-cancel { background: #fff5f5; color: var(--danger); border: 1px solid #feb2b2; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .pax-badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2>Admin Don Tasko</h2>
        <input type="password" id="passInput" placeholder="CÃ³digo de Acesso">
        <button onclick="verificarPass()">Entrar</button>
        <p id="erro" style="color:var(--danger); display:none; margin-top:15px;">Acesso Negado!</p>
    </div>
</div>

<div id="dashboard-content">
    <div class="header">
        <div>
            <h1>ðŸ“Š Painel de Controlo</h1>
            <div class="live-status">
                <span id="statusDot" class="dot"></span>
                <span id="statusText">Sincronizando...</span>
            </div>
        </div>
        <button style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;" onclick="carregarDados()">ðŸ”„ Atualizar</button>
    </div>

    <div class="container">
        <div class="side-col">
            <div class="card">
                <h2>ðŸ“… OcupaÃ§Ã£o (15 Dias)</h2>
                <div id="resumo15" class="scroll-resumo">A carregar...</div>
            </div>
            <div class="card">
                <h2>âž• Reserva Manual</h2>
                <form id="formManual">
                    <input type="text" name="nome" placeholder="Nome" required style="width:100%; padding:8px; margin-bottom:10px;">
                    <input type="tel" name="telemovel" placeholder="TelemÃ³vel" required style="width:100%; padding:8px; margin-bottom:10px;">
                    <input type="date" name="data" id="dataManual" required style="width:48%; padding:8px;">
                    <input type="number" name="pax" value="2" min="1" style="width:45%; padding:8px;">
                    <select name="horario" required style="width:100%; padding:8px; margin-top:10px;">
                        <option value="12:30">12:30</option><option value="13:00">13:00</option><option value="19:30">19:30</option><option value="20:00">20:00</option>
                    </select>
                    <button type="submit" style="width:100%; margin-top:10px; background:var(--accent); color:white; border:none; padding:10px; border-radius:8px;">Gravar</button>
                </form>
            </div>
        </div>
        <div class="main-col">
            <div class="card">
                <h2>ðŸ”œ PrÃ³ximas Reservas (Ordenadas)</h2>
                <table id="tabelaProximas">
                    <thead><tr><th>Data/Hora</th><th>Cliente</th><th>Pax</th><th>Obs</th><th>AÃ§Ã£o</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let URL_SCRIPT = "https://script.google.com/macros/s/AKfycbwCBe0OmHpM8RPyAifVLgJ6PJ7G42d7paXYWRC89doUVahf8_ZECe53sWPy5aDHhZEd/exec";
    const PASS_CORRETA = "Tasko123";
    let LOTACAO_MAX = 30;
    const somDing = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    let ultimaQtd = 0;

    function verificarPass() {
        if (document.getElementById('passInput').value === PASS_CORRETA) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            document.getElementById('dataManual').value = new Date().toISOString().split('T')[0];
            carregarDados();
            setInterval(carregarDados, 60000);
        } else { document.getElementById('erro').style.display = 'block'; }
    }

    async function carregarDados() {
        try {
            const [confRes, dashRes] = await Promise.all([
                fetch(URL_SCRIPT, { method: 'POST', body: JSON.stringify({action: 'getConfigs'}) }).then(r => r.json()),
                fetch(URL_SCRIPT, { method: 'POST', body: JSON.stringify({action: 'getDashboard'}) }).then(r => r.json())
            ]);

            // AUTO-UPDATE URL: Se o URL na aba Config for diferente, atualiza para a prÃ³xima vez
            if (confRes.URL && confRes.URL !== URL_SCRIPT) URL_SCRIPT = confRes.URL;
            LOTACAO_MAX = parseInt(confRes.LOTACAO_MAXIMA) || 30;

            if (ultimaQtd > 0 && dashRes.listaGeral.length > ultimaQtd) somDing.play().catch(()=>{});
            ultimaQtd = dashRes.listaGeral.length;

            renderizarOcupacao(dashRes.resumoCompleto);
            renderizarReservas(dashRes.listaGeral);
            document.getElementById('statusText').innerText = "Sincronizado: " + new Date().toLocaleTimeString();
        } catch (e) { document.getElementById('statusText').innerText = "Erro na ligaÃ§Ã£o"; }
    }

    function renderizarOcupacao(resumo) {
        const container = document.getElementById('resumo15');
        container.innerHTML = '';
        Object.keys(resumo).sort().forEach(dia => {
            const p = resumo[dia];
            container.innerHTML += `
                <div class="dia-card">
                    <strong>${dia}</strong>
                    <div>AlmoÃ§o: ${p.almoco}/${LOTACAO_MAX} ${barra(p.almoco)}</div>
                    <div>Jantar: ${p.jantar}/${LOTACAO_MAX} ${barra(p.jantar)}</div>
                </div>`;
        });
    }

    function barra(pax) {
        const perc = Math.min((pax/LOTACAO_MAX)*100, 100);
        const cor = perc >= 100 ? 'color-full' : perc >= 80 ? 'color-high' : 'color-low';
        return `<div class="barra-progresso"><div class="barra-fill ${cor}" style="width:${perc}%"></div></div>`;
    }

    function renderizarReservas(lista) {
        const tbody = document.querySelector('#tabelaProximas tbody');
        // OrdenaÃ§Ã£o garantida por Data e Hora
        lista.sort((a, b) => new Date(a.data + 'T' + a.hora) - new Date(b.data + 'T' + b.hora));
        
        tbody.innerHTML = lista.map(r => `
            <tr>
                <td>${r.data}<br><strong>${r.hora}</strong></td>
                <td><strong>${r.nome}</strong><br><small>${r.tel}</small></td>
                <td><span class="pax-badge">${r.pax}</span></td>
                <td>${r.obs || ""}</td>
                <td><button class="btn-cancel" onclick="cancelar('${r.nome}','${r.hora}','${r.data}')">X</button></td>
            </tr>
        `).join('');
    }

    async function cancelar(n, h, d) {
        if (confirm("Cancelar esta reserva?")) {
            await fetch(URL_SCRIPT, { method: 'POST', body: JSON.stringify({action: 'cancelarAdmin', nome: n, hora: h, data: d}) });
            carregarDados();
        }
    }

    document.getElementById('formManual').onsubmit = async function(e) {
        e.preventDefault();
        const dados = Object.fromEntries(new FormData(this));
        dados.action = "reservaManual";
        await fetch(URL_SCRIPT, { method: 'POST', body: JSON.stringify(dados) });
        this.reset();
        carregarDados();
    };
</script>
</body>
</html>
